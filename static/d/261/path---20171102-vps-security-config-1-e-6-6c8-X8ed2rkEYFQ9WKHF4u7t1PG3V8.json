{"data":{"site":{"siteMetadata":{"title":"Jon's Blog","author":""}},"markdownRemark":{"id":"626bbed1-f991-5728-9a22-185afec62d3c","excerpt":"vps安全设置 设置防火墙\nUFW: Uncomplicated Firewall\nUbuntu系统默认自带，但默认未激活 提示Status: inactive\nDifferent applications can register their profiles with UFW upon installation…","html":"<h2>vps安全设置</h2>\n<ul>\n<li>\n<p>设置防火墙\nUFW: Uncomplicated Firewall\nUbuntu系统默认自带，但默认未激活</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">sudo ufw status</code></pre></div>\n<p>提示Status: inactive\nDifferent applications can register their profiles with UFW upon installation.\nThese profiles allow UFW to manage these applications by name.\n尽管我们没激活UFW，但是OpenSSH has a profile registered with UFW.</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">sudo ufw app list</code></pre></div>\n<p>但这并不意味这OpenSSH默认是被允许的，现在ufw只是知道有OpenSSH这么个玩意而已。\n所以我们要先告诉ufw允许OpenSSH，然后再激活ufw服务。以免一会ssh被防火墙了连不上vps了。</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">sudo ufw allow OpenSSH</code></pre></div>\n<p>据说如果OpenSSH不是默认的22端口的话会出错，不确定是否谣言，不过为以防万一，检查下。\n查看下ssh的设置：</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">less /etc/ssh/sshd_config</code></pre></div>\n<p>/etc/ssh/ssh<em>config是ssh客户端的配置，/etc/ssh/sshd</em>config是ssh服务器段守护进程的设置，所以我们在VPS这里当然查看服务端配置了。\n当然了，客户端要与服务端端口设置一致才能成功连接上ssh啦\n嗯，我们看一看到sshd_config中的端口为27207，我们也就是用着个端口号登录的ssh呀\n但是查看ufw中注册的profile端口号是Port: 22/tcp，查看命令如下：</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">sudo ufw app info OpenSSH</code></pre></div>\n<p>照这么说我们之前allow OpenSSH其实是开了22端口？但我们ssh需要的27207端口反而没开？\n我们可以不适用profile的名称而直接使用端口号来指定要开放的端口<code class=\"language-text\">sudo ufw allow 27207</code>\n但如果我们同时运行了这两条代码，是不是就同时开放了22和27207端口？多开放了一个22吧。或者只运行后一条命令。这里我们不运行这条代码。\n我们也可以纠正profile，然后只运行前一条命令。\n<code class=\"language-text\">man ufw</code>我们可以查到这样的描述： ufw supports application integration by reading profiles located in /etc/ufw/applications.d. 其实本渣渣是先谷歌再man的。\n所以我们用vim修改下：</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">vim /etc/ufw/applications.d/openssh-server</code></pre></div>\n<p>修改完成后保存时提示只读，所以我们其实应该通过sudo vim来修改这个文件。这里有个小技巧，可以sudo保存未用sudo vim打开的文件：</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">:w !sudo tee %</code></pre></div>\n<p>然后按l键(L)oad\n再查看下发现已经自动更新了，虽然有app update PROFILE命令。。。</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">sudo ufw app info OpenSSH</code></pre></div>\n<p>既然如此我们就激活防火墙吧</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">sudo ufw enable</code></pre></div>\n<p>我们可以查看下status，然后退出ssh重新登录试下。事实证明退出ssh去就登不上了。。。\n此时指定以22端口<code class=\"language-text\">ssh -p 22 zhao@stillbroken.me</code>登录ssh会收到提示被拒绝；指定27207或27208或272之类的会没用回应。\n由此可见，之前allow OpenSSH命令时确实开放了profile中默认的22端口而且未开放27207端口，因此VPS响应了22端口的ssh请求，但由于端口号不正确，因此回复拒绝；而以其他端口尝试ssh登录则直接被墙了，这是由于后面我们虽然修改了profile但未应用。\n只好在bandwagonhost的控制台用root登录然后运行ufw app update OpenSSH，然后就可以登录了。。。单纯的重启VPS是没用的。\n好吧，看来虽然<code class=\"language-text\">sudo ufw app info OpenSSH</code>命令结果显示改了，但只是文件改了，配置还需要通过<code class=\"language-text\">sudo app update OpenSSH</code>来加载修改后的配置。\n切记！！！要update配置！\n可见profile其实就像命令行中的alias一样或者ip的域名一样，只是指定了一个端口号的人类易于记忆的名字而已。\n现在我们的shadowsocks也不能用啦，赶紧开放端口！\n直接在ufw的配置文件夹/etc/ufw/applications.d/下新建：\n/etc/ufw/applications.d/shadowsocks-libev</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">[Shadowsockslibev]\ntitle=shadowsocks service\ndescription=Shadowsocks is a lightweight socks5 proxy, Originally written in Python. Shadowsocks-libev is written in C.\nports=8388        </code></pre></div>\n<p>此时运行sudo ufw app list即可发现多了个应用Shasowsockslibev</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">sudo ufw app update all\nsudo ufw status\nsudo ufw allow Shadowsockslibev\nsudo ufw status</code></pre></div>\n<p>现在ss可以用了。\n编辑/etc/ufw/applications.d/中的配置文件后，若没新添加app，这update就行了；若新增加了app，需要allow。最后通过status查看状态。</p>\n</li>\n</ul>","frontmatter":{"title":"","date":null}}},"pageContext":{"slug":"/20171102-vps-security-config/","previous":{"fields":{"slug":"/开篇-自警/"},"frontmatter":{"title":""}},"next":null}}