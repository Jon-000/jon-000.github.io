{"data":{"site":{"siteMetadata":{"title":"Jon's Blog","author":""}},"markdownRemark":{"id":"dbd7e881-ab81-5504-a317-a9f15007aa8a","excerpt":"learn express web framework setup environment install nvm     是用来管理node版本的，Node Version Manager   activate nvm by sourcing it from your shell   写入terminal…","html":"<h1>learn express web framework</h1>\n<h2>setup environment</h2>\n<h3>install nvm</h3>\n<p>  <a href=\"https://github.com/creationix/nvm\"><code class=\"language-text\">nvm</code></a> 是用来管理node版本的，Node Version Manager</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">  cd ~/\n  git clone https://github.com/creationix/nvm.git .nvm\n  cd .nvm\n  git checkout v0.33.4</code></pre></div>\n<p>  activate nvm by sourcing it from your shell</p>\n<p>  写入terminal的配置文件实现自动source</p>\n<p>  以bash为例子，则在<code class=\"language-text\">~/.bashrc</code>添加如下</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">  export NVM_DIR=&quot;$HOME/.nvm&quot;\n  [ -s &quot;$NVM_DIR/nvm.sh&quot; ] &amp;&amp; \\. &quot;$NVM_DIR/nvm.sh&quot;  # This loads nvm\n  [ -s &quot;$NVM_DIR/bash_completion&quot; ] &amp;&amp; \\. &quot;$NVM_DIR/bash_completion&quot;  # This loads nvm bash_completion</code></pre></div>\n<p>  安装后可能需要重新打开命令行。</p>\n<p>  一些指令：</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">  nvm --help //查看帮助信息\n  nvm ls //查看已安装的版本\n  nvm ls-remote //远程可用版本\n  nvm install --lts //安装最新的LTS版本，默认别名为default\n  nvm install v8 //安装8+版本的最新版,默认别名为node以及stable\n  nvm version node //查看node所指代的版本\n  nvm version stable //查看stable所指代的版本\n  nvm version default //查看default所指代的版本\n  nvm use default //指定使用的版本为default所指代的版本\n  nvm which node //显示别名node所指代的路径\n  nvm which default //显示别名default所指代的路径\n  nodejs --version //因为是通过nvm而非如node官网指示的方式进行安装，会提示nodejs未安装\n  node --version //结果为nvm use所指定的版本\n  which node //结果为nvm use所指定的版本的路径\n  nvm install v8 --reinstall-packages-from=v8 //更新当前使用的8+版本到最新LTS的8+版本，如8.9.1到8.9.3</code></pre></div>\n<p>  在命令行中使用<code class=\"language-text\">node</code>命令时，即指向<code class=\"language-text\">nvm use &lt;version&gt;</code>所指代的node版本,路径在~/.nvm的后代目录中</p>\n<p>  <code class=\"language-text\">nvm</code>将各版本node安装至~/.nvm/versions/node目录下，通过<code class=\"language-text\">nvm use &lt;version&gt;</code>改变shell中<code class=\"language-text\">node</code>命令指向.nvm目录下的不同Node版本</p>\n<p>  npm为对应版本node的npm</p>\n<p>  !更深入的理解需要复习linux的文件系统和shell等相关知识．</p>\n<h2>创建项目的方式</h2>\n<h3>方式一：手动建立一个app</h3>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">  mkdir myapp\n  cd myapp\n  npm init //按照提示设置一些信息，这些信息将会存入./package.json文件\n  npm install express --save //安装express这个package,--save的作用是将安装的package版本信息作为dependencies存入package.json文件\n  npm install eslint --save-dev //保存为开发环境下才使用的包</code></pre></div>\n<p>  在js文件中，通过<code class=\"language-text\">require()</code>来引入,例如在myapp/index.js文件中：</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\">  <span class=\"token keyword\">var</span> express <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'express'</span><span class=\"token punctuation\">)</span>\n  <span class=\"token keyword\">var</span> app <span class=\"token operator\">=</span> <span class=\"token function\">express</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>  在package.json文件中可以设置命令行命令的别名，再通过<code class=\"language-text\">npm run-script &lt;别名&gt;</code>或<code class=\"language-text\">npm run &lt;别名&gt;</code>运行.\n例如，可在myapp/package.json中添加设置：</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">  &quot;scripts&quot;: {\n    &quot;lint&quot;: &quot;eslint /home/forward/test/express/myapp/index.js\n  }</code></pre></div>\n<p>  然后可以在<code class=\"language-text\">myapp/</code>目录下运行<code class=\"language-text\">npm run lint</code></p>\n<h3>方式二：通过express application generator建立一个app</h3>\n<p>The Express Application Generator is not the only generator for Express applications,and the generated project is not the only viable way to structure your files and directories.</p>\n<p>就是个方便搭架子的工具</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">npm install express-generator -g //参数-g表示全局安装\nexpress myapp2\ncd myapp2\nnpm install\nDEBUG=myapp2:* npm start</code></pre></div>\n<h2>项目练习:The Local Library website</h2>\n<p>做一个app需要考量这些方面：</p>\n<ul>\n<li>快速生产：熟练程度，学习曲线</li>\n<li>流行程度：社区活力，技术支持</li>\n<li>语言风格</li>\n<li>性能</li>\n<li>特性</li>\n</ul>\n<p>技术选择：</p>\n<ul>\n<li>\n<p>view engine:</p>\n<ul>\n<li><a href=\"https://github.com/expressjs/express/wiki#template-engines\">使用express已支持的引</a></li>\n<li><a href=\"https://expressjs.com/en/guide/using-template-engines.html\">配置express未支持的引擎</a></li>\n</ul>\n</li>\n<li>\n<p>CSS stylesheet engine:</p>\n<ul>\n<li>LESS</li>\n<li>SASS</li>\n<li>Compass</li>\n<li>Stylus</li>\n</ul>\n</li>\n<li>\n<p>database:</p>\n<ul>\n<li>express创建的app可以使用任何Node支持的数据库</li>\n<li><a href=\"https://expressjs.com/en/guide/database-integration.html\">express database integration guide</a></li>\n</ul>\n</li>\n</ul>\n<p>使用database的两种方式：</p>\n<ul>\n<li>Using the databses’ native qurey language (e.g. SQL)</li>\n<li>Using an Object Data Model (“ODM”) / Object Relational Model (“ORM”)\n</li>\n</ul>\n<p>本项目：</p>\n<ul>\n<li>目录名称：express-locallibrary-tutorial</li>\n<li>模板引擎：Pug template library</li>\n<li>CSS引擎：无</li>\n</ul>\n<p>步骤：</p>\n<div class=\"gatsby-highlight\" data-language=\"sh\"><pre class=\"language-sh\"><code class=\"language-sh\">mkdir LearnExpress //创建一个新的学习目录\ncd LearnExpress\nexpress express-locallibrary-tutorial --view=pug\ncd express-locallibrary-tutorial\nnpm install //安装package.json中所指定的dependency packages\nDEBUG=express-locallibrary-tutorial:* npm start //可访问http://localhost:3000/\nnpm install nodemon --save-dev //实现实时更新，安装nodemon提供支持express website修改后服务器的自动重启，nodemon: https://github.com/remy/nodemon</code></pre></div>\n<p>版本：<code class=\"language-text\">&quot;express&quot;: &quot;~4.15.2&quot;</code>,<code class=\"language-text\">&quot;pug&quot;: &quot;~2.0.0-beta11&quot;</code></p>\n<p>此时nodemon为非全局安装，不能直接在命令行中使用．</p>\n<p>可以设置package.json文件,添加如下内容，通过<code class=\"language-text\">npm run-script 别名</code>运行,<code class=\"language-text\">npm start</code>为特例，即<code class=\"language-text\">npm run start</code>省略<code class=\"language-text\">run</code></p>\n<div class=\"gatsby-highlight\" data-language=\"json\"><pre class=\"language-json\"><code class=\"language-json\"><span class=\"token property\">\"script\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token property\">\"start\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"node ./bin/www\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"devstart\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"nodemon ./bin/www\"</span> //此行和上一行末尾的逗号为添加内容\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span></code></pre></div>\n<p>现在可以依如下命令运行，附注：此时仍不能用<code class=\"language-text\">nodemon ./bin/www</code>在命令行运行，会提示找不到命令，因为非全局安装，不添加path只有npm知道运行nodemon</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">DEBUG<span class=\"token operator\">=</span>express-locallibrary-tutorial:* <span class=\"token function\">npm</span> run devstart</code></pre></div>\n<p>亦可输入<code class=\"language-text\">rs</code>重启.服务器</p>\n<p>当在命令行运行<code class=\"language-text\">npm run devstart</code>时，会运行express-locallibrary-tutorial/bin/www</p>\n<p>www文件为application entry point</p>\n<p>在www文件第一行便通过<code class=\"language-text\">var app = require(&#39;../app&#39;)</code>引用了module，即app.js文件，此处代码省略了可选的”.js”后缀．</p>\n<p><code class=\"language-text\">require()</code>是一个global node function</p>\n<p>在app.js文件中</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">var</span> express <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'express'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">//引入express,import a module by name, module name!两种方式： name; path</span>\n<span class=\"token keyword\">var</span> app <span class=\"token operator\">=</span> <span class=\"token function\">express</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">//创建一个express application object，按惯例命名为app</span>\n<span class=\"token operator\">...</span> <span class=\"token comment\">//对这一app对象添加设置</span>\nmodule<span class=\"token punctuation\">.</span>exports <span class=\"token operator\">=</span> app<span class=\"token punctuation\">;</span>　<span class=\"token comment\">//export the app from the module</span></code></pre></div>\n<p>当我们导入一个模块的时候，便导入了这一对象．</p>\n<p>Back in the www entry point file above, it is this <code class=\"language-text\">module.exports</code> object that is supplied to the caller when this file is imported.</p>\n<p>由此可以看出，对于一个module文件：</p>\n<p>第一部分是其依赖，即该模块所需导入的模块，此例即第一行，是app.js模块所需要导入的模块，也可能需要导入不止一个依赖</p>\n<p>第二部分即此例第二行，是创建app模块的对象</p>\n<p>中间是对这一对象的配置</p>\n<p>最后一行则是导出创建的对象</p>\n<p>??所以module的含义是把一个巨大的object单独存成一个文件进行配置??</p>\n<p>  A module is a JavaScript library/file that you can import into other code using Node’s <code class=\"language-text\">require()</code> function.\nExpress itself is a module, as are the middleware and database libraries that we use in our Express applications.\nYou will want to create your own modules, because this allows you to organise your code into managable parts — a monolithic single-file application is hard to understand and maintain.\nUsing modules also helps you manage your namespace, because only the variables you explicitly export are imported when you use a module.\nTo make objects available outside of a module you just need to assign them to the <code class=\"language-text\">exports</code> <strong>object</strong>.</p>\n<p>see <a href=\"https://developer.mozilla.org/en-US/docs/Learn/Server-side/Express_Nodejs/Introduction#Importing_and_creating_modules\">MDN</a>\n更多有关module机制的学习有待进行，<a href=\"https://nodejs.org/docs/latest-v6.x/api/modules.html\">Node module doc</a></p>\n<p>route模块的机制\n路由的module文件统一存放在express-locallibrary-tutorial/routes文件夹下\n以express-locallibrary-tutorial/routes/index.js为例</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">  var express = require(&#39;express&#39;); //依赖\n  var router = express.Router();　//创建express的router对象\n\n  router.get(&#39;/&#39;, function(req, res, next){\n    res.render(&#39;index&#39;, {title: &#39;Express&#39;});\n  });\n\n  module.exports = router; //输出router对象</code></pre></div>\n<p>在app.js中</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">  ...\n  var index = require(&#39;./routes/index&#39;); //导入index路由模块\n  ...\n  app.use(&#39;/&#39;, index); //使用导入的module\n  ...</code></pre></div>\n<p>可以看到，在app.js和/routes/index.js中两次设置了路径的匹配方式\n在app.js中设置的路径将会作为前缀加到index.js中设置的路径上．\n例如：在app.js中设置路径’/users’，在./routes/users.js中设置路径为’/profile’\n则匹配路径为/users/profile</p>\n<p>以<code class=\"language-text\">router.get(){}</code>函数为例，其接受两个参数：匹配路径和callback函数\n匹配路径参数可有三种提供形式：\n1.写死的strings，例如： ’/’, ‘/about’, ‘/book’, ’/’\n2.string patterns，这算是一个正则表达式的子集，规则包括一下４条：</p>\n  <li>`?`:0 or more of the preceding character. E.g. a route path of `'/ab?cd'` will matche endpoints `acd`, `abcd`, `abbcd` etc.\n  <li>`+`:1 or more of the preceding character.\n  <li>`*`:an arbitrary string where the * character is placed.\n  <li>`()`:Grouping match on a set of characters to perform another operation on. E.g. `'/ab(cd)?e'` will peform a ? match on (cd), it will match `abe`, `abcde`, `abcdcde`, and so on.\n<p>3.JavaScript <a href=\"https://developer.mozilla.org/en-US/docs/Web/JavaScript/Guide/Regular_Expressions\">regular expressions</a>\n例如：<code class=\"language-text\">app.get(/.*fish$/, function(req, res){})</code>，注意此例没有引号．\n一个关于路径参数的技术：\nRoute parameters:提取路径的片段信息\nRoute parameters are named URL segments used to capture the values specified at thier position in the URL.\n实现思路：以:后面跟变量名的形式对应于URL上的路径片段，则此变量名将获得对应路径片对的值，储存于req.params对象，通过点加变量名的形式进行调用．\n例如：</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">  app.get(&#39;/user/:userId/books/:bookId&#39;, function(req, res){\n\n  })</code></pre></div>\n<p>若请求get地址<code class=\"language-text\">http://localhost:3000/users/34/books/8989</code>\n则</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">  req.params.userId = 34\n  req.params.bookId = 8989</code></pre></div>\n<p>注意：\n1.The names of route parameters must be made up of “word characters”(A-Z, a-z, 0-9, and _).\n2.路由的先后顺序．例如除了以上URL路径，我们还需处理<code class=\"language-text\">/book/create</code>，我们并不希望捕获<code class=\"language-text\">req.params.userId = create</code>，我们希望执行的是其他操作，此时我们需要将处理此URL路径的route定义于<code class=\"language-text\">/book/:bookId</code>这个路由的前面．\n更多相关知识有待更深入学习<a href=\"http://expressjs.com/en/starter/basic-routing.html\">Express doc</a></p>\n<p>callback函数接受三个参数：req, res, next\nthe HTTP Request object, HTTP response ,and the next function in the middleware chain.\nRouter functions are Express middleware, Which means they must either complete(respond to) the request or call the next function in the chain.\nThere are a <a href=\"https://expressjs.com/en/guide/routing.html#response-methods\">number of response methods</a> for ending the request/response cycle.\nAbout middleware in <a href=\"https://developer.mozilla.org/en-US/docs/Learn/Server-side/Express_Nodejs/Introduction#Using_middleware\">MDN</a>.\nThe <code class=\"language-text\">Router</code> provides route methods for all HTTP verbs,用法大致相同</p>\n  <li>`get()`\n  <li>`put()`\n  <li>`delete()`\n  <li>`options()`\n  <li>`trace()`\n  <li>`copy()`\n  <li>`lock()`\n  <li>`mkcol()`\n  <li>`move()`\n  <li>`purge()`\n  <li>`propfind()`\n  <li>`proppatch()`\n  <li>`unlock()`\n  <li>`report()`\n  <li>`mkactivity()`\n  <li>`checkout()`\n  <li>`merge()`\n  <li>`m-search()`\n  <li>`notify()`\n  <li>`subscribe()`\n  <li>`unsubscribe()`\n  <li>`patch()`\n  <li>`search()`\n  <li>`connect()`\n<p>view机制\n在app.js中设置模板引擎：</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">  ...\n  app.set(&#39;views&#39;, path.join(__dirname, &#39;views&#39;));\n  app.set(&#39;view engine&#39;, &#39;pug&#39;);\n  ...</code></pre></div>\n<p>Serving static files\n<a href=\"http://expressjs.com/en/4x/api.html#express.static\">express.static</a> middleware</p>\n<p>添加数据库</p>\n<p>安装MongoDB\n<a href=\"https://www.mongodb.com/download-center#community\">在ubuntu 16.04 LTS中apt安装Community Server版</a></p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">  sudo apt-key adv --keyserver hkp://keyserver.ubuntu.com:80 --recv 0C49F3730359A14518585931BC711F9BA15703C6\n  echo &quot;deb [ arch=amd64,arm64 ] http://repo.mongodb.org/apt/ubuntu xenial/mongodb-org/3.4 multiverse&quot; | sudo tee /etc/apt/sources.list.d/mongodb-org-3.4.list\n  sudo apt-get update\n  sudo apt-get install -y mongodb-org</code></pre></div>\n<p>This version of MongoDB does not restrict network access by default. Please review the <a href=\"https://docs.mongodb.com/manual/administration/security-checklist/?_ga=2.28129982.323441757.1509515501-1649049113.1506302297\">security checklist</a> for instructions on how to prevent unauthorized access.\n运行MongoDB</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">  sudo service mongod start //start MongoDB\n  sudo service mongod stop //stop MongoDB\n  sudo service mongod restart //restart MongoDB</code></pre></div>\n<p>验证Mongo成功启动，查看日志/var/log/mongodb/mongod.log，提示<code class=\"language-text\">waiting for connections on port &amp;lt;port&amp;gt;</code></p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">  tail -f /var/log/mongodb/mongod.log //-f用来持续监控实时更新</code></pre></div>\n<p>端口号默认为27017，可在/etc/mongod.conf中配置\n默认数据存储文件路径为/var/lib/mongodb，默认日志文件路径为/var/log/mongodb,也在/etc/mongod.conf中配置</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">  ...\n  # Where and how to store data\n  storage:\n    dbPath: /var/lib/mongodb\n    journal:\n      enabled: true\n  ...\n  # where to write logging data\n  systemLog:\n    destination: file\n    logAppend: true\n    path: /var/log/mongodb/mongod.log\n  ...\n  # network interfaces\n  net:\n    port: 27017\n    bindIp: 127.0.0.1\n...</code></pre></div>\n<p>此处仍有两个知识点有待学习，UNIX ulimit Settings和user account，相关描述如下：\nMost Unix-like operating systems limit the system resources that a session may use. These limits may nagatively impact MongoDB operation. See <a href=\"https://docs.mongodb.com/manual/reference/ulimit/\">UNIX ulimit Settings</a> for more information.\nThe MongoDB instance stores its data files in /var/lib/mongodb and its log files in /var/log/mongodb by default, and runs using the mongodb user account. You can specify alternate log and data file directories in /etc/mongod.conf.\nIf you change the user that runs the MongoDB process, you must modify the access control rights to the /var/lib/mongodb and /var/log/mongodb directories to give this user access to these directories.</p>\n<p><a href=\"https://docs.mongodb.com/manual/mongo/\"><code class=\"language-text\">mongo</code> shell</a>\nan interactive JavaScript interface to MongoDB\n已作为Community server版的一部分安装\n运行mongo shell需要先运行MongoDB服务!\nWhen you run <code class=\"language-text\">mongo</code> without any arguments, the mongo shell will attempt to connect to the MongoDB instance running on the localhost interface on port 27017. To specify a different host or port number, as well as other options, see <a href=\"https://docs.mongodb.com/manual/reference/program/mongo/\">mongo Shell Reference Page</a>.\n??所以可以通过mongo远程连接数据库服务器？需要什么配置和验证？？\nSSH登录VPS后，安装好Mongodb，初步设置UFW防火墙后。\nIf you intend to use the MongoDB server only locally with applications running on the same server,这就足够了。\n若需要从远程连接数据库，需要设置UFW开通对应端口，UFW还可以设置访问者的ip。</p>\n<p>安装Mongoose</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">  npm install mongoose --save //在app目录下运行，同时--save选项保存mongoose依赖至package.json</code></pre></div>\n<p>版本：<code class=\"language-text\">&quot;mongoose&quot;: &quot;^4.11.13&quot;</code>\n引用mongoose，连接MongoDB</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">  var mongoose = require(&#39;mongoose&#39;); // Import the mongoose module\n  var mongoDB_addr = &#39;mongodb://127.0.0.1/databaseName&#39; // 将数据库地址设为变量便于操作\n  mongoose.connect(mongoDB_addr, { // Set up mongoose conncetion\n    useMongoClient: true\n  });</code></pre></div>\n<p>Mongoose的默认连接逻辑自4.11.0弃用，新的连接逻辑使用<code class=\"language-text\">useMongoClient</code>选项\n添加连接的两种方式：</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">  // Using `mongoose.connect`\n  var promise = mongoose.connect(&#39;mongodb://localhost/databaseName&#39;, {\n    useMongoClient: true,\n    /* other options */\n  })\n  // Or `createConnection`\n  var promise = mongoose.createConnection(&#39;mongodb://localhost/databaseName&#39;, {\n    useMongoClient: true,\n    /* other options */\n  });\n  // Or, if you already have a connection\n  connection.openUri(&#39;mongodb://localhost/databaseName&#39;, {/* options */})</code></pre></div>\n<p>连接后会创建一个connection对象\nThis connection object is then used to create and retrieve models. Models are <strong>always</strong> scoped to a single connection.</p>\n<p>检测连接成功和连接错误</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">  db.on(&#39;error&#39;, console.error.bind(console, &#39;connection error:&#39;));\n  db.once(&#39;open&#39;, function(){\n    // we&#39;re connected!\n  })</code></pre></div>\n<p>Models are defined using the <code class=\"language-text\">mongoose.Schema</code> interface.\nSchemas are then “compiled” into models using <code class=\"language-text\">mongoose.model()</code> method.\nSchema相当于是Model的规划表,model用来具体实现CRUD功能，model相当于mongoDB中的collection，model的instance代表组成collection的document．\n先通过<code class=\"language-text\">mongoose.Schema</code>创建一个规划表（<code class=\"language-text\">new</code>一个新对象）\n然后通过<code class=\"language-text\">mongoose.model</code>创建新model，此方法接受两个参数：model的单数形式名字，建造此model所依照的规划表即schema对象</p>\n<p>如何使用mongoose\n建议：One schema/model per file\n１．建立model</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">  // File: myapp/models/modelName1.js\n\n  // Require Mongoose\n  var mongoose = require(&#39;mongoose&#39;);\n  // Define a schema\n  var modeName1Schema = new mongoose.Schema({\n    FieldName1 : String,\n    FieldName2 : Date,\n  });\n  // Export function to create &quot;modelName1&quot; model class\n  module.exports = mongoose.model(&#39;modelName1&#39;, modelName1Schema);</code></pre></div>\n<p>此即创建了一个名为modelName1的类class，这个类当然同时也是一个object.待导出即可用\n２．使用model</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">  // Create a modelName1 model just by requiring the module\n  var modelName1 = require(&#39;../models/modelName1.js&#39;)\n  // Use the modelName1 object (model) to find all modelName1 records\n  modelName1.find(callback_function);</code></pre></div>\n<p>mongoose的CRUD操作均为异步操作(asynchronous operation)，You supply a callback that is called when the operation completes.\nThe API uses the error-first argument convention, so the first argument for the callback will always be an error value(or null). If the API returns some result, this will be provided as the second argument.\n例如：</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">  modelName1.create({ name: &#39;recordName1&#39;}, function(err, recordName1_instance){\n    if (err) return handleError(err);\n  })</code></pre></div>\n<p>创建一个modelName1的新record，提供一个object对象<code class=\"language-text\">{name: &#39;recordName1&#39;}</code>描述如何创建新record，提供一个callback函数<code class=\"language-text\">function(err, instance){}</code>，当创建操作完成后，调用此函数，按照惯例或约定，n默认第一个参数总是error value(or null)，若有返回值，如本例子中返回创建的新record实例，则作为callback函数的第二个参数．</p>\n<p>附录：</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">  Following are all valid Schema Types.\n    String\n    Number\n    Date\n    Buffer\n    Boolean\n    Mixed\n    Objectid\n    Array</code></pre></div>\n<p>更多细节有待更深入学习mongoose通过其<a href=\"http://mongoosejs.com/index.html\">doc</a></p>\n<p>controllers:functions that separate out the code to route requests from the code that actually processes requests.</p>","frontmatter":{"title":"express学习笔记","date":"September 18, 2017","tags":["ubuntu","DNS"]}}},"pageContext":{"previous":{"fields":{"urlPath":"/20170910"},"frontmatter":{"title":"开篇-自警","publish":true,"tags":["自警","鲁迅"]}},"next":{"fields":{"urlPath":"/20180408"},"frontmatter":{"title":"ubuntu 16.04 安装mysql","publish":true,"tags":null}}}}