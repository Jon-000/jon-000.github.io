{"data":{"site":{"siteMetadata":{"title":"Jon's Blog","author":""}},"markdownRemark":{"id":"c52bb05c-2cd5-5d9d-b894-43f25931c21e","excerpt":"what is CORS? Cross-Origin Resource Sharing(CORS) is a mechanism that uses additional HTTP header to let a user agent gain permission to access selected…","html":"<h3>what is CORS?</h3>\n<p>Cross-Origin Resource Sharing(CORS) is a mechanism that uses additional HTTP header to let a user agent gain permission to access selected resources from a server on a different origin(domain) than the site currently in use.</p>\n<p>人话：</p>\n<p>特殊情况(cross-origin HTTP request)下，user agent(browser)资源获取被禁止。\n通过设置HTTP headers，从而允许资源的获取。亦即sharing</p>\n<p>比如我们访问a网站，则浏览器发送<code class=\"language-text\">GET /</code>请求至a服务器，此时确定了a服务器为origin。\na服务器返回给浏览器html，浏览器解析html并根据html请求图片、css等资源，这些资源若都在a服务器上，都可以请求。\n若有个别资源不在a服务器上在b服务器上怎么办？\n制定规则的大佬给了个解决办法，就叫CORS。a为origin，请求b便是cross-origin,图片文本等便是资源Resource，b的东西让a申请下来的html用，便是分享Sharing。\n怎么实现呢？\n浏览器和服务器沟通时，要告诉服务器浏览器是谁，什么情况，然后服务器根据情况决定给不给这个浏览器资源。\n浏览器发送http请求时，设置专门的http header，这些都由浏览器自动完成。那么浏览器都干了点啥呢？额外设置了http头，具体怎么设置的呢？暂不关心。\n关键问题在于，浏览器发送<code class=\"language-text\">GET /</code>和<code class=\"language-text\">GET /image.png</code>是两次独立的http事件，虽然我们在浏览器这里知道我们一个浏览器发了两个http请求，\n服务器也收到两个http请求，但服务器不知道这俩请求是同一个浏览器发的，也不知道是否是某个特定origin发送的html发起的请求。\n所以一旦浏览器在http头中把这些情况交代清楚了，服务器便可以根据情况来确定怎么答复了。\n比如可以只允许特定origin的访问获取资源。或者允许任意origin的访问。\n那么倘若我们不用浏览器发送http请求，用个curl甚至自己写个http client，然后在构造http头时填入服务器所需要的origin，不就也可以获取资源了吗？\n应该是这样的，不过意义不大，只是通过非cors的方式绕过了单一origin获取资源的限制，这只是在其他密码等各种认证之外的额外一层而已。\n那么假若我建了一个c站服务器在c服务器，当我访问c站时，origin便设定成了c，此时如果我请求只允许a站origin获取资源的b站时，便不被允许获取资源了。\n那么我c站可否用js自己构建http头以适应b站的要求呢？貌似是不被允许的，就像自动设置的cookie一样？大佬们给出的唯一出路便是CORS。</p>\n<p>\n  <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/c274d3ad68f9b67e9509024793d3c729/1e6b8/CORS_principle.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n  \n  <span\n    class=\"gatsby-resp-image-wrapper\"\n    style=\"position: relative; display: block;  max-width: 590px; margin-left: auto; margin-right: auto;\"\n  >\n    <span\n      class=\"gatsby-resp-image-background-image\"\n      style=\"padding-bottom: 69.51351351351352%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAOCAYAAAAvxDzwAAAACXBIWXMAABDrAAAQ6wFQlOh8AAADxUlEQVQ4y2NgIACUFRS4lJVU1DXU1GVVVNRUVJTV5IFYTU1FTU5SQkYVQ8P///9BWBKIJUD46fOXEnPmLZAESjGB5OfMXwxXa2pmweTp4cWcmVXICOLv3neM/cmLdxpv3n+1ffX2s9mzV59EGVasWLF269at/3Zs3/598+ZNPy5cOP/t5Yvn/0+cOL4SqIfPx9uXS0tTR0JHW1dOTk6BS1hYiLW+oYkNZOD9R89n/IeAfyDi24/fbxh27tz5f9GiRf8XL132f/bcBf/Pnr8Mlr195+777KwsdT5eIS57O0dRfX1DQTY2dnYmJka2/PwCLpCBL16+3gEy6O3b97/fv/8ANpTh1q1bv1+/eftv4f6n/1pXXv9XM+fon/I5Z/5PXXv26aE1E6VAGivLK5jDw8PB3nRzc2Pas2cvK4j99duP5a9fv/5/797d7w8e3P/94cOHPwxnzpz+e/7Cpf8ZPXv+OeQs+e+as+CvT/X2/4U9656vnl6vzCmmzRkdFSMaFRXNW1hUzJ6elsa5a9duDpCBwPBe9x8NMJw7e/bv5StX/s/ddPZf97IT/yesPve3f/W5/4s3n3y+bfkUSfRIBBrMmpCUygxiv37/VfbLt19RX7//yv/y7Wfm52+/HBiu37jx99mLF/9fvHj679WrZ/9fvXj69+PHt/8fPrz/NCc7R0FMRNRCRUXVQlFOwV5RXsFWQV7RTFZOQRzkGKzgYmXj33smTv/vOfj+u2vr/f+mnfffx9ae/2+39j1rvHZeGhhwAtpaOuIqyioiysqq4kpKyhwwvZ+//9P4+Plb8bfvP1u/fPvR8P7T91CGWzHpvx8z8P27xSfz7zG39L97PNJ/HrKJ/r+aXvCs4uQRZaA+5pCQUG4NLS1mqDnM7R1dYEOfvXizESMM7586+//90ZP/XwHxaxA+cuL/uxNn/t84cepdaV2tmpqMHLefr5+wrY09LzcnN6uQkBBrc0sLJ8jADx8/r/n8+fP/+w8efnv06PGvHz9+/GI4dubMzqfv3v5/+vbNVyD+/uz9u6+PXr78v//w4a1APRz+gQGspiYmbLLSMiysrMxMxibGLPPnz2eDpsNtf/78+f/yxYu/b9++/f/z509wwDIWZGTax4RFhCZFx/olRsf65mdkudTHJYHTmpqaOr+crAKvmqqGIDAMBTXVNaUCA4MFQXLff/5pguaSr0D84++//3dh4QvKt/wgFwExO5Rm0NfT4wQWDGYqyqoOQNoJiI2UFJUdgAZrwjReu/Nc/Pmrj9qPn79X3XX0OgcAtA8MF0pw7aIAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n    >\n      <img\n        class=\"gatsby-resp-image-image\"\n        style=\"width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;\"\n        alt=\"CORS principle\"\n        title=\"\"\n        src=\"/static/c274d3ad68f9b67e9509024793d3c729/40fad/CORS_principle.png\"\n        srcset=\"/static/c274d3ad68f9b67e9509024793d3c729/707e9/CORS_principle.png 148w,\n/static/c274d3ad68f9b67e9509024793d3c729/649e0/CORS_principle.png 295w,\n/static/c274d3ad68f9b67e9509024793d3c729/40fad/CORS_principle.png 590w,\n/static/c274d3ad68f9b67e9509024793d3c729/b3fef/CORS_principle.png 885w,\n/static/c274d3ad68f9b67e9509024793d3c729/1e6b8/CORS_principle.png 925w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n      />\n    </span>\n  </span>\n  \n  </a>\n    </p>\n<p>可见有两个方面需要讨论：</p>\n<ol>\n<li>\n<p>特殊情况具体是指什么情况？</p>\n<p>A user agent makes a cross-origin HTTP request when it requests a resource from a different domain, protocol, or port than the one from which the current document originated.\n人话：\n在浏览器的本浏览页新发起一个资源请求，但是该请求与获取本浏览页时所用的请求的的domain、protocl、port不同，此时发送的请求即cross-origin HTTP request</p>\n</li>\n<li>\n<p>如何设置HTTP headers？</p>\n</li>\n</ol>\n<p>浏览器端的设置有浏览器自动完成，服务器端需要自己设置。\n可见CROS这一机制需要浏览器端和服务器端的支持。</p>\n<p>浏览器端的请求头中有Origin字段，指出请求来源，例如<code class=\"language-text\">Origin: http://foo.example</code>,不含路径信息只有服务器名。</p>\n<p>适用对象：\nXMLHttpRequest和Fetch API均属于以上描述的限制和解决方案的适用者。这两者发出的请求有可能符合被限制的情形，需要适时地适用CORS机制摆脱限制。</p>\n<p>设置的http headers如何发挥作用？</p>\n<p>分两种情形：</p>\n<ol>\n<li>Simple requests，不触发预检(preflight)</li>\n<li>Preflighted requests，需先使用OPTIONS方法发送一个http请求作为预检</li>\n</ol>\n<p>什么情景算是Simple requests？</p>\n<p>同时符合以下条件：</p>\n<ol>\n<li>\n<p>http methods：</p>\n</li>\n<li>\n<p>GET</p>\n</li>\n<li>\n<p>HEAD</p>\n</li>\n<li>\n<p>POST</p>\n</li>\n<li>\n<p>headers字段属于以下三种情形，只有最后一种可以手动设置</p>\n<ul>\n<li>\n<p>user agent自动设置的,例如</p>\n<ul>\n<li>Connection</li>\n<li>User-Agent</li>\n</ul>\n</li>\n<li>headers with names defined in the Fetch spec as a “forbidden header name”\n<a href=\"https://fetch.spec.whatwg.org/#forbidden-header-name\">spec详情</a></li>\n<li>\n<p>headers which the Fetch spec defines as being a “CORS-safelisted request-header”\n<a href=\"https://fetch.spec.whatwg.org/#cors-safelisted-request-header\">spec详情</a></p>\n<ul>\n<li>Accept</li>\n<li>Accept-Language</li>\n<li>Content-Language</li>\n<li>\n<p>Content-Type\n并且这一字段的取值只能是以下三个</p>\n<ul>\n<li>application/x-www-form-urlencoded</li>\n<li>multipart/form-data</li>\n<li>text/plain</li>\n</ul>\n</li>\n<li>DPR</li>\n<li>Downlink</li>\n<li>Save-Data</li>\n<li>Viewport-Width</li>\n<li>Width</li>\n</ul>\n</li>\n</ul>\n</li>\n</ol>\n<p>No event listeners are registered on any XMLHttpRequestUpload object used in the request; these are accessed using the XMLHttpRequest.upload property.</p>\n<p>No ReadableStream object is used in the request\n<br>\n什么情景算preflighted requests</p>\n<p>todo</p>\n<p>服务器端能对http header做哪些设置？</p>\n<ul>\n<li>\n<p>Access-Control-Allow-Origin</p>\n</li>\n<li>\n<p>Access-Control-Expose-Headers</p>\n</li>\n<li>\n<p>Access-Control-Max-Age</p>\n</li>\n<li>\n<p>Access-Control-Allow-Credentials</p>\n</li>\n<li>\n<p>Access-Control-Allow-Methods</p>\n</li>\n<li>\n<p>Access-Control-Allow-Headers</p>\n</li>\n</ul>","frontmatter":{"title":"CORS","date":"December 02, 2017","tags":null}}},"pageContext":{"previous":{"fields":{"urlPath":"/20170918"},"frontmatter":{"title":"express学习笔记","publish":true,"tags":["ubuntu","DNS"]}},"next":{"fields":{"urlPath":"/20180321"},"frontmatter":{"title":"CSS animation & Transition","publish":true,"tags":null}}}}